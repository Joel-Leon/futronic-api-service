# ?? Arquitectura del Sistema de Huellas Dactilares

## ?? Resumen Ejecutivo

Este documento describe la arquitectura completa del sistema de gestión de huellas dactilares con **Futronic Service como única fuente de verdad** para la configuración.

---

## ??? Diagrama de Arquitectura Completo

```
????????????????????????????????????????????????????????????????????????????????
?                         ARQUITECTURA DEL SISTEMA                              ?
????????????????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????????????
?                              CAPA DE PRESENTACIÓN                            ?
???????????????????????????????????????????????????????????????????????????????
?                                                                              ?
?  ??????????????????????????????????????????????????????????????             ?
?  ?         FRONTEND (React/Vue/Angular)                        ?             ?
?  ?                                                             ?             ?
?  ?  ????????????????????    ????????????????????             ?             ?
?  ?  ? Panel de Admin   ?    ? Registro Huella  ?             ?             ?
?  ?  ?  - Configuración ?    ?  - Captura Live  ?             ?             ?
?  ?  ?  - Validación    ?    ?  - Progreso      ?             ?             ?
?  ?  ????????????????????    ????????????????????             ?             ?
?  ?            ?                       ?                       ?             ?
?  ?            ?????????????????????????                       ?             ?
?  ?                        ?                                   ?             ?
?  ?         ??????????????????????????????????                ?             ?
?  ?         ? fingerprintConfig.service.ts   ?                ?             ?
?  ?         ?  - HTTP Client (Axios)         ?                ?             ?
?  ?         ?  - SignalR Client              ?                ?             ?
?  ?         ?  - Event Emitter               ?                ?             ?
?  ?         ??????????????????????????????????                ?             ?
?  ????????????????????????????????????????????????????????????             ?
?                            ?          ?                                     ?
?                            ?          ? SignalR WebSocket                   ?
?                    HTTP    ?          ? (notificaciones)                    ?
???????????????????????????????????????????????????????????????????????????????
                             ?          ?
???????????????????????????????????????????????????????????????????????????????
?                         CAPA DE LÓGICA DE NEGOCIO                            ?
????????????????????????????????????????????????????????????????????????????????
?                                                                              ?
?  ??????????????????????????????????????????????????????????????             ?
?  ?         BACKEND API (.NET 8)                                ?             ?
?  ?                                                             ?             ?
?  ?  ????????????????????????????????????????????????????????  ?             ?
?  ?  ?        FingerprintConfigSyncService                  ?  ?             ?
?  ?  ?                                                      ?  ?             ?
?  ?  ?  1. Recibe request del frontend                     ?  ?             ?
?  ?  ?  2. Valida (opcional)                               ?  ?             ?
?  ?  ?  3. ??????? Llama a Futronic Service API           ?  ?             ?
?  ?  ?  4. ??????? Recibe configuración actualizada        ?  ?             ?
?  ?  ?  5. Guarda COPIA en BD (auditoría)                 ?  ?             ?
?  ?  ?  6. Retorna a frontend                              ?  ?             ?
?  ?  ????????????????????????????????????????????????????????  ?             ?
?  ?                        ?          ?                         ?             ?
?  ?                        ?          ?                         ?             ?
?  ?                  HTTP  ?          ? HTTP Response           ?             ?
?  ???????????????????????????????????????????????????????????????             ?
?                           ?          ?                                       ?
?  ???????????????????????????????????????????????????????????????             ?
?  ?        Database (PostgreSQL/SQL Server/MySQL)               ?             ?
?  ?                                                              ?             ?
?  ?  ????????????????????????????????????????????????????????   ?             ?
?  ?  ?  FingerprintConfigurations Table (COPIA DE RESPALDO) ?   ?             ?
?  ?  ?  ??????????????????????????????????????????????????? ?   ?             ?
?  ?  ?  - Id                                                ?   ?             ?
?  ?  ?  - Threshold                                         ?   ?             ?
?  ?  ?  - Timeout                                           ?   ?             ?
?  ?  ?  - MaxRotation                                       ?   ?             ?
?  ?  ?  - DetectFakeFinger                                  ?   ?             ?
?  ?  ?  - TemplatePath                                      ?   ?             ?
?  ?  ?  - OverwriteExisting                                 ?   ?             ?
?  ?  ?  - CreatedAt                                         ?   ?             ?
?  ?  ?  - LastUpdated                                       ?   ?             ?
?  ?  ?  - LastSyncedAt ???? Timestamp de última sincro     ?   ?             ?
?  ?  ????????????????????????????????????????????????????????   ?             ?
?  ????????????????????????????????????????????????????????????????             ?
????????????????????????????????????????????????????????????????????????????????
                                    ?          ?
                              HTTP  ?          ? HTTP Response
                                    ?          ?
????????????????????????????????????????????????????????????????????????????????
?                    CAPA DE SERVICIOS ESPECIALIZADOS                           ?
????????????????????????????????????????????????????????????????????????????????
?                                                                              ?
?  ??????????????????????????????????????????????????????????????             ?
?  ?         FUTRONIC SERVICE (.NET 8) - FUENTE DE VERDAD       ?             ?
?  ?                                                             ?             ?
?  ?  ????????????????????????????????????????????????????????  ?             ?
?  ?  ?        FingerprintController (REST API)              ?  ?             ?
?  ?  ?                                                      ?  ?             ?
?  ?  ?  ? GET    /api/fingerprint/config                  ?  ?             ?
?  ?  ?  ? PUT    /api/fingerprint/config                  ?  ?             ?
?  ?  ?  ? PATCH  /api/fingerprint/config                  ?  ?             ?
?  ?  ?  ? POST   /api/fingerprint/config/validate         ?  ?             ?
?  ?  ?  ? POST   /api/fingerprint/config/reset            ?  ?             ?
?  ?  ?  ? POST   /api/fingerprint/config/reload           ?  ?             ?
?  ?  ????????????????????????????????????????????????????????  ?             ?
?  ?                     ?                                       ?             ?
?  ?                     ?                                       ?             ?
?  ?  ????????????????????????????????????????????????????????  ?             ?
?  ?  ?        ConfigurationService                          ?  ?             ?
?  ?  ?                                                      ?  ?             ?
?  ?  ?  - Valida configuración (Data Annotations)          ?  ?             ?
?  ?  ?  - Valida reglas de negocio                         ?  ?             ?
?  ?  ?  - Persiste en fingerprint-config.json              ?  ?             ?
?  ?  ?  - Notifica cambios a FingerprintService            ?  ?             ?
?  ?  ????????????????????????????????????????????????????????  ?             ?
?  ?                     ?                                       ?             ?
?  ?                     ?                                       ?             ?
?  ?  ????????????????????????????????????????????????????????  ?             ?
?  ?  ?        fingerprint-config.json (PERSISTENCIA)        ?  ?             ?
?  ?  ?  ??????????????????????????????????????????????????  ?  ?             ?
?  ?  ?  {                                                   ?  ?             ?
?  ?  ?    "threshold": 70,                                  ?  ?             ?
?  ?  ?    "timeout": 30000,                                 ?  ?             ?
?  ?  ?    "maxRotation": 199,                               ?  ?             ?
?  ?  ?    "detectFakeFinger": false,                        ?  ?             ?
?  ?  ?    "templatePath": "C:/temp/fingerprints",           ?  ?             ?
?  ?  ?    "overwriteExisting": false,                       ?  ?             ?
?  ?  ?    ...                                               ?  ?             ?
?  ?  ?  }                                                   ?  ?             ?
?  ?  ????????????????????????????????????????????????????????  ?             ?
?  ?                                                             ?             ?
?  ?  ????????????????????????????????????????????????????????  ?             ?
?  ?  ?        FingerprintHub (SignalR)                      ?  ?             ?
?  ?  ?                                                      ?  ?             ?
?  ?  ?  - SubscribeToNotifications(dni)                    ?  ?             ?
?  ?  ?  - UnsubscribeFromNotifications(dni)                ?  ?             ?
?  ?  ?  - ReceiveProgress (event)                          ?  ?             ?
?  ?  ?                                                      ?  ?             ?
?  ?  ?  Eventos:                                            ?  ?             ?
?  ?  ?  ? operation_started                                 ?  ?             ?
?  ?  ?  ? sample_started                                    ?  ?             ?
?  ?  ?  ? sample_captured (con imagen base64)              ?  ?             ?
?  ?  ?  ? operation_completed                               ?  ?             ?
?  ?  ?  ? error                                             ?  ?             ?
?  ?  ????????????????????????????????????????????????????????  ?             ?
?  ?                                                             ?             ?
?  ?  ????????????????????????????????????????????????????????  ?             ?
?  ?  ?        FutronicFingerprintService                    ?  ?             ?
?  ?  ?                                                      ?  ?             ?
?  ?  ?  - Interactúa con SDK de Futronic                   ?  ?             ?
?  ?  ?  - Captura huellas dactilares                       ?  ?             ?
?  ?  ?  - Registra templates (.tml)                        ?  ?             ?
?  ?  ?  - Verifica identidad                               ?  ?             ?
?  ?  ?  - Identifica usuario (1:N)                         ?  ?             ?
?  ?  ?  - Usa configuración de ConfigurationService        ?  ?             ?
?  ?  ????????????????????????????????????????????????????????  ?             ?
?  ????????????????????????????????????????????????????????????               ?
????????????????????????????????????????????????????????????????????????????????
                                    ?
                                    ?
????????????????????????????????????????????????????????????????????????????????
?                              CAPA DE HARDWARE                                 ?
????????????????????????????????????????????????????????????????????????????????
?                                                                              ?
?  ??????????????????????????????????????????????????????????????             ?
?  ?         Futronic SDK + Dispositivo USB                      ?             ?
?  ?                                                             ?             ?
?  ?  ????????????????????????????????????????????????????????  ?             ?
?  ?  ?  Futronic FS88 / FS80 / FS50 Scanner                ?  ?             ?
?  ?  ?  - Captura de huella dactilar en tiempo real        ?  ?             ?
?  ?  ?  - Detección de liveness (dedo falso)               ?  ?             ?
?  ?  ?  - Generación de templates biométricos              ?  ?             ?
?  ?  ????????????????????????????????????????????????????????  ?             ?
?  ????????????????????????????????????????????????????????????               ?
????????????????????????????????????????????????????????????????????????????????
```

---

## ?? Flujo de Actualización de Configuración

### **Escenario: Administrador cambia el threshold de 70 a 80**

```
??????????????????????????????????????????????????????????????????????????
?                     FLUJO PASO A PASO                                   ?
??????????????????????????????????????????????????????????????????????????

1?? FRONTEND (Panel de Admin)
   ????????????????????????????????????????????????????
   ? Admin abre panel de configuración                ?
   ? Cambia threshold: 70 ? 80                        ?
   ? Click en "Guardar"                               ?
   ????????????????????????????????????????????????????
                    ?
                    ?
   fingerprintConfigService.updateConfiguration({ threshold: 80, ... })
                    ?
                    ? HTTP PUT
                    ?

2?? BACKEND API (Validación y Routing)
   ????????????????????????????????????????????????????
   ? POST /api/fingerprint/config                     ?
   ? FingerprintConfigSyncService.UpdateConfiguration ?
   ????????????????????????????????????????????????????
                    ?
                    ? 1. Valida datos (opcional)
                    ? 2. Prepara request
                    ?
                    ? HTTP PUT
                    ?

3?? FUTRONIC SERVICE (Fuente de Verdad)
   ????????????????????????????????????????????????????
   ? PUT /api/fingerprint/config                      ?
   ? FingerprintController.UpdateConfiguration        ?
   ????????????????????????????????????????????????????
                    ?
                    ?
   ????????????????????????????????????????????????????
   ? ConfigurationService.UpdateConfigurationAsync    ?
   ?                                                  ?
   ?  ? Valida con Data Annotations                 ?
   ?  ? Valida reglas de negocio                    ?
   ?     (threshold entre 0-100, timeout >= 5000...)?
   ?  ? Persiste en fingerprint-config.json         ?
   ?  ? Notifica a FingerprintService               ?
   ????????????????????????????????????????????????????
                    ?
                    ? File System Write
                    ?
   ????????????????????????????????????????????????????
   ? fingerprint-config.json                          ?
   ? {                                                ?
   ?   "threshold": 80,  ??? ACTUALIZADO             ?
   ?   "timeout": 30000,                              ?
   ?   ...                                            ?
   ? }                                                ?
   ????????????????????????????????????????????????????
                    ?
                    ? Return Success
                    ?
   ????????????????????????????????????????????????????
   ? Response: { success: true, data: { ... } }      ?
   ????????????????????????????????????????????????????
                    ?
                    ? HTTP 200 OK
                    ?

4?? BACKEND API (Persistencia de Respaldo)
   ????????????????????????????????????????????????????
   ? Recibe configuración actualizada                 ?
   ? SaveConfigurationCopyToDatabase()                ?
   ????????????????????????????????????????????????????
                    ?
                    ? SQL UPDATE
                    ?
   ????????????????????????????????????????????????????
   ? Database - FingerprintConfigurations             ?
   ? UPDATE ... SET Threshold = 80, LastSyncedAt = .. ?
   ????????????????????????????????????????????????????
                    ?
                    ? Return to Frontend
                    ?

5?? FRONTEND (Actualización UI)
   ????????????????????????????????????????????????????
   ? Recibe response                                  ?
   ? Actualiza estado local                           ?
   ? Muestra mensaje: "? Configuración actualizada"  ?
   ????????????????????????????????????????????????????
```

---

## ?? Principios de Diseño

### **1. Single Source of Truth**
- ? **Futronic Service** es la única fuente de verdad
- ? Toda modificación DEBE pasar por Futronic Service API
- ? Backend solo guarda copia de respaldo/auditoría
- ? NUNCA modificar directamente la BD y esperar sincronización

### **2. Validación en Múltiples Capas**
```
Frontend ? Validación UI (opcional)
    ?
Backend ? Validación de negocio (opcional)
    ?
Futronic Service ? Validación estricta (obligatoria)
```

### **3. Persistencia Dual**
- **Primaria:** `fingerprint-config.json` (Futronic Service)
- **Secundaria:** Base de datos (Backend) - Solo para auditoría/respaldo

### **4. Comunicación en Tiempo Real**
- SignalR para notificaciones de progreso
- Eventos granulares (sample_started, sample_captured, etc.)
- Suscripción por DNI para filtrado

---

## ?? Comparación: Antes vs Después

### **? ANTES (Problemático)**
```
Backend modifica BD
    ?
    ?
Futronic Service NO SE ENTERA
    ?
    ?
Configuración desincronizada ?
```

### **? AHORA (Correcto)**
```
Backend llama Futronic Service API
    ?
    ?
Futronic Service actualiza fingerprint-config.json
    ?
    ?
Backend guarda copia en BD
    ?
    ?
Configuración sincronizada ?
```

---

## ??? Seguridad y Control de Acceso

```
Frontend
    ?
    ? JWT Token
    ?
Backend API (Autenticación + Autorización)
    ?
    ? [Authorize(Roles = "Admin")]
    ?
Futronic Service (Sin autenticación - internal network)
```

**Recomendaciones:**
- Backend maneja autenticación/autorización
- Futronic Service debe estar en red interna
- Usar firewall para restringir acceso al puerto 5000

---

## ?? Escalabilidad

### **Escenario: Múltiples Terminales**

```
Terminal 1 (Sucursal A) ???
                          ?
Terminal 2 (Sucursal B) ?????? Backend API ??? Futronic Service (Central)
                          ?
Terminal 3 (Sucursal C) ???
```

Cada terminal:
1. Se comunica con el backend central
2. Backend sincroniza con Futronic Service central
3. Configuración se replica automáticamente

---

## ?? Monitoreo y Logs

### **Logs Estructurados**

```
??????????????????????????????????????????????????????????
?                    LOGS DEL SISTEMA                     ?
??????????????????????????????????????????????????????????
?                                                         ?
?  Frontend (Console)                                     ?
?  ?? ?? Actualizando configuración...                   ?
?  ?? ? Configuración actualizada exitosamente          ?
?  ?? ?? Notificación SignalR: sample_captured           ?
?                                                         ?
?  Backend API (Structured Logging)                      ?
?  ?? [INFO] Solicitud de actualización de config        ?
?  ?? [INFO] Llamando a Futronic Service...              ?
?  ?? [INFO] Guardando copia en BD...                    ?
?  ?? [INFO] ? Sincronización completada                ?
?                                                         ?
?  Futronic Service (Serilog)                            ?
?  ?? [INFO] ?? GET /api/fingerprint/config              ?
?  ?? [INFO] ?? PUT /api/fingerprint/config              ?
?  ?? [INFO] ? Configuración persistida en JSON         ?
?  ?? [INFO] ?? SignalR: Notificación enviada            ?
?                                                         ?
??????????????????????????????????????????????????????????
```

---

## ? Checklist de Implementación

### **Backend**
- [ ] Crear `FingerprintConfigSyncService`
- [ ] Crear entidad `FingerprintConfigurationEntity`
- [ ] Agregar endpoints en controller
- [ ] Configurar HttpClient para Futronic Service
- [ ] Implementar fallback a BD si servicio no disponible

### **Futronic Service**
- [ ] Agregar endpoints de configuración en `FingerprintController`
- [ ] Verificar `IConfigurationService` completo
- [ ] Configurar persistencia en `fingerprint-config.json`
- [ ] Probar todos los endpoints (GET, PUT, PATCH, etc.)

### **Frontend**
- [ ] Crear `fingerprintConfig.service.ts`
- [ ] Implementar componente de configuración
- [ ] Integrar SignalR para notificaciones
- [ ] Agregar manejo de errores
- [ ] Estilizar UI

### **Testing**
- [ ] Unit tests del servicio de sincronización
- [ ] Integration tests de endpoints
- [ ] E2E test del flujo completo
- [ ] Test de reconexión SignalR

---

## ?? Documentos Relacionados

- [Integración Backend](./BACKEND-INTEGRATION.md) - Guía completa para .NET backend
- [Integración Frontend](./FRONTEND-INTEGRATION.md) - Guía para React/Vue/Angular
- [API Reference](./API-REFERENCE.md) - Documentación completa de endpoints
- [Troubleshooting](./TROUBLESHOOTING.md) - Solución de problemas comunes

---

## ?? Conclusión

Esta arquitectura garantiza:
? **Consistencia** - Una única fuente de verdad
? **Confiabilidad** - Respaldo en BD para fallback
? **Escalabilidad** - Múltiples terminales sincronizados
? **Trazabilidad** - Auditoría completa de cambios
? **Tiempo Real** - Notificaciones vía SignalR

**Principio fundamental:** 
> "Futronic Service es la fuente de verdad, Backend es el intermediario, Frontend es el consumidor"
